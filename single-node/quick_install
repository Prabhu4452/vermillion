#!/bin/bash

set -e 
YELLOW='\033[1;33m'
NC='\033[0m'
owner="rbccps-iisc"
repo="iudx-resource-server"

directory=`dirname $0`
cd $directory

admin_passwd=`cat /dev/urandom | env LC_CTYPE=C tr -dc a-zA-Z0-9 | head -c 32; echo`
postgres_passwd=`cat /dev/urandom | env LC_CTYPE=C tr -dc a-zA-Z0-9 | head -c 32; echo`
mongo_passwd=`cat /dev/urandom | env LC_CTYPE=C tr -dc a-zA-Z0-9 | head -c 32; echo`

if [ -e ".env" ]
then
    rm .env
fi

echo "ADMIN_PWD="$admin_passwd > .env
echo "POSTGRES_PWD="$postgres_passwd >> .env
echo "QUICK_INSTALL=true" >> .env
echo "SINGLE_NODE=true" >> .env
echo "MONGO_INITDB_ROOT_USERNAME=root" >> .env
echo "MONGO_INITDB_ROOT_PASSWORD="$mongo_passwd >> .env

if  [ ! -f ../iudx-api-server/target/iudx-api-server-0.0.1-SNAPSHOT-fat.jar ]	    || \
    [ ! -f ../iudx-authenticator/target/iudx-authenticator-0.0.1-SNAPSHOT-fat.jar ]
then
    echo "Downloading jar files from the latest release..." >&2
    curl -s https://api.github.com/repos/$owner/$repo/releases/latest \
    | grep browser_download_url | cut -d '"' -f 4 | xargs curl -LJ# > jars.tar.gz

    tar -zxf jars.tar.gz
    mkdir -p ../iudx-api-server/target/
    mkdir -p ../iudx-authenticator/target/
    mv jars/iudx-api-server-0.0.1-SNAPSHOT-fat.jar ../iudx-api-server/target/
    mv jars/iudx-authenticator-0.0.1-SNAPSHOT-fat.jar ../iudx-authenticator/target/
    rm -rf jars
    rm jars.tar.gz
fi

docker-compose down -v
docker-compose up -d
